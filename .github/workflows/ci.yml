name: CI
on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  ci:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: Windows
          - os: ubuntu-latest
            name: Linux
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
      - name: Azure login
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_ACI_CREDENTIALS }}
      - name: Run
        id: run
        uses: ./
        with:
          azure-credentials: ${{ secrets.AZURE_ACI_CREDENTIALS }}
          tag: setup-azurefunctions-action
      - name: Validate
        shell: pwsh
        env:
          FunctionsPublishProfile: ${{ steps.run.outputs.publish-profile }}
        run: |
          $hostname = "${{ steps.run.outputs.hostname }}"
          echo "Functions app hostname is $hostname"
          if ($hostname.Length -le 0) {
            throw "Host name was not set by action"
          }
          $publishProfile = $Env:FunctionsPublishProfile
          echo "Publish profile length is $($publishProfile.Length)"
          if ( $publishProfile.Length -le 0 ) {
            throw "Environment variable 'FunctionsPublishProfile' not set by action."
          }